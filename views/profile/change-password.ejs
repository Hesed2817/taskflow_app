<%- include('../layouts/main.ejs') -%>

    <div class="profile-container">
        <div class="profile-header-section">
            <a href="/profile" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Profile
            </a>
            <h1 class="profile-title">Change Password</h1>
            <p class="profile-subtitle">Update your password to keep your account secure</p>
        </div>

        <div class="profile-card">
            <form id="changePasswordForm" class="profile-form">
                <div class="profile-form-group">
                    <label class="profile-form-label">
                        Current Password *
                    </label>
                    <div class="password-wrapper">
                        <input type="password" name="currentPassword" required class="profile-form-input"
                            placeholder="Enter your current password" autocomplete="current-password">
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility(this)"
                            aria-label="Show password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="profile-form-group">
                    <label class="profile-form-label">
                        New Password *
                    </label>
                    <div class="password-wrapper">
                        <input type="password" name="newPassword" required minlength="6" class="profile-form-input"
                            placeholder="At least 6 characters" autocomplete="new-password">
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility(this)"
                            aria-label="Show password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="password-requirements">
                        Must be at least 6 characters long
                    </div>
                </div>

                <div class="profile-form-group">
                    <label class="profile-form-label">
                        Confirm New Password *
                    </label>
                    <div class="password-wrapper">
                        <input type="password" name="confirmPassword" required minlength="6" class="profile-form-input"
                            placeholder="Re-enter your new password" autocomplete="new-password">
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility(this)"
                            aria-label="Show password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="password-match-error" id="passwordMatchError">
                        Passwords do not match
                    </div>
                </div>

                <div class="profile-form-actions">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                    <a href="/profile" class="btn btn-secondary">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/password-toggle.js"></script>
    <script>
        document.getElementById('changePasswordForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Get error element
            const passwordMatchError = document.getElementById('passwordMatchError');
            passwordMatchError.style.display = 'none';

            // Validate passwords match
            if (data.newPassword !== data.confirmPassword) {
                passwordMatchError.style.display = 'block';
                return;
            }

            // Validate password length
            if (data.newPassword.length < 6) {
                showAlert('warning', 'Password must be at least 6 characters long');
                return;
            }

            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'Password changed successfully! Please login again.');
                    setTimeout(() => {
                        window.location.href = '/logout';
                    }, 500);
                } else {
                    showAlert('error', result.message || 'Failed to change password');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Change password error:', error);
                showAlert('error', 'Network error: ' + error.message);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Real-time password validation
        document.querySelectorAll('.profile-form-input[name="newPassword"], .profile-form-input[name="confirmPassword"]').forEach(input => {
            input.addEventListener('input', function () {
                const newPassword = document.querySelector('.profile-form-input[name="newPassword"]').value;
                const confirmPassword = document.querySelector('.profile-form-input[name="confirmPassword"]').value;
                const passwordMatchError = document.getElementById('passwordMatchError');

                if (confirmPassword && newPassword !== confirmPassword) {
                    passwordMatchError.style.display = 'block';
                } else {
                    passwordMatchError.style.display = 'none';
                }

                // Update password requirement indicator
                const requirements = document.querySelector('.password-requirements');
                if (newPassword.length < 6) {
                    requirements.style.color = 'var(--color-danger)';
                } else {
                    requirements.style.color = 'var(--color-success)';
                }
            });
        });
    </script>