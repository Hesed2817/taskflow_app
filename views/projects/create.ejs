<%- include('../layouts/main.ejs') -%>

<div class="projects-container project-form-container">
    <div class="project-header">
        <a href="/projects" class="project-back-link">
            <i class="fas fa-arrow-left"></i> Back to Projects
        </a>
        <h1 class="project-title">Create New Project</h1>
        <p class="project-subtitle">Start organizing your work with a new project</p>
    </div>

    <div class="project-form-card">
        <form id="createProjectForm" class="project-form">
            <div class="project-form-group">
                <label class="project-form-label">
                    Project Name *
                </label>
                <input 
                    type="text" 
                    name="name" 
                    required 
                    placeholder="e.g., Website Redesign, Marketing Campaign"
                    class="project-form-input"
                    autocomplete="off"
                >
            </div>

            <div class="project-form-group">
                <label class="project-form-label">
                    Description
                </label>
                <textarea 
                    name="description" 
                    rows="4"
                    placeholder="Describe the project goals, objectives, and scope..."
                    class="project-form-textarea"
                ></textarea>
            </div>

            <div class="project-form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create Project
                </button>
                <a href="/projects" class="btn btn-secondary">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('createProjectForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Project...';
    submitBtn.disabled = true;

    try {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        console.log('Creating project with data:', data);

        // ✅ CRITICAL: Use credentials: 'include' for cookies
        const response = await fetch('/api/projects', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
                // NO Authorization header - cookie will be sent automatically
            },
            body: JSON.stringify(data),
            credentials: 'include' // ← THIS SENDS THE COOKIE
        });

        console.log('Response status:', response.status);

        const result = await response.json();
        console.log('API Response:', result);

        if (result.success) {
            // Redirect to the new project
            showAlert('success', 'Project created successfully!');
            setTimeout(() => {
                window.location.href = '/projects/' + result.data._id;
            }, 1500);
        } else {
            // Show error message
            showAlert('error', result.message || 'Failed to create project');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('Create project error:', error);
        showAlert('error', 'Network error: ' + error.message);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});
</script>