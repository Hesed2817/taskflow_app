<%- include('../layouts/main.ejs') -%>

<div class="projects-container project-settings-container">
    <!-- Page Header -->
    <div class="project-header">
        <a href="/projects/<%= project._id %>" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Project
        </a>
        <h1 class="project-title">Project Settings: <%= project.name %></h1>
        <p class="project-subtitle">Manage project configuration and ownership</p>
    </div>

    <!-- Project Information -->
    <div class="project-settings-section">
        <h2 class="project-settings-title">Project Information</h2>

        <div class="project-info-grid">
            <div class="project-info-item">
                <span class="project-info-label">Project Name</span>
                <div class="project-info-value"><%= project.name %></div>
            </div>

            <div class="project-info-item">
                <span class="project-info-label">Description</span>
                <div class="project-info-value">
                    <%= project.description || 'No description provided' %>
                </div>
            </div>

            <div class="project-info-item">
                <span class="project-info-label">Current Owner</span>
                <div class="settings-member-info">
                    <div class="settings-member-avatar settings-member-avatar-owner">
                        <%= project.createdBy.username.charAt(0).toUpperCase() %>
                    </div>
                    <div class="settings-member-details">
                        <div class="settings-member-name"><%= project.createdBy.username %></div>
                        <div class="settings-member-role"><%= project.createdBy.email %></div>
                    </div>
                </div>
            </div>

            <div class="project-info-item">
                <span class="project-info-label">Created Date</span>
                <div class="project-info-value">
                    <%= new Date(project.createdAt).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }) %>
                </div>
            </div>
        </div>
    </div>

    <!-- Editing settings -->
    <div class="project-settings-section">
        <h2 class="project-settings-title">Edit Project Details</h2>
        <p class="project-subtitle" style="margin-bottom: var(--space-md);">Update project name, description, or other details.</p>
        <a href="/projects/<%= project._id %>/edit" class="btn btn-primary">
            <i class="fas fa-edit"></i> Edit Project
        </a>
    </div>

    <!-- Project Members -->
    <div class="project-settings-section">
        <h2 class="project-settings-title">Project Members</h2>

        <div class="settings-member-list">
            <!-- Owner -->
            <div class="settings-member-item">
                <div class="settings-member-info">
                    <div class="settings-member-avatar settings-member-avatar-owner">
                        <%= project.createdBy.username.charAt(0).toUpperCase() %>
                    </div>
                    <div class="settings-member-details">
                        <div class="settings-member-name"><%= project.createdBy.username %></div>
                        <div class="settings-member-role">Owner • <%= project.createdBy.email %></div>
                    </div>
                </div>
                <span style="color: var(--color-primary); font-weight: bold;">You</span>
            </div>

            <!-- Members -->
            <% project.members.forEach(member => { %>
                <div class="settings-member-item">
                    <div class="settings-member-info">
                        <div class="settings-member-avatar settings-member-avatar-member">
                            <%= member.username.charAt(0).toUpperCase() %>
                        </div>
                        <div class="settings-member-details">
                            <div class="settings-member-name"><%= member.username %></div>
                            <div class="settings-member-role">Member • <%= member.email %></div>
                        </div>
                    </div>
                    <button onclick="removeMember('<%= member._id %>', '<%= member.username %>')" 
                            class="btn-icon btn-icon-delete"
                            title="Remove member">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            <% }) %>
        </div>

        <div style="text-align: center; color: var(--color-text-secondary); font-style: italic;">
            <% const teamMembers = project.members.filter(member =>
                member._id.toString() !== project.createdBy._id.toString()
            ); %>
            <%= teamMembers.length %> member(s) total
        </div>
    </div>

    <!-- Danger Zone -->
    <div class="danger-zone">
        <h2 class="danger-zone-title">
            <i class="fas fa-exclamation-triangle"></i> Danger Zone
        </h2>
        <p class="danger-zone-warning">
            These actions are irreversible. Please proceed with caution.
        </p>

        <!-- Transfer Ownership -->
        <div class="danger-zone-section">
            <h3 class="danger-zone-section-title">Transfer Project Ownership</h3>
            <p class="danger-zone-section-text">
                Transfer ownership to another project member. You will become a regular member after transfer.
            </p>

            <div class="transfer-ownership-form">
                <select id="newOwnerSelect" class="form-control form-select">
                    <option value="">Select a member...</option>
                    <% project.members.forEach(member => { %>
                        <option value="<%= member._id %>">
                            <%= member.username %> (<%= member.email %>)
                        </option>
                    <% }) %>
                </select>
                <button onclick="transferOwnership()" class="btn btn-danger">
                    Transfer Ownership
                </button>
            </div>
        </div>

        <!-- Delete Project -->
        <div class="danger-zone-section">
            <h3 class="danger-zone-section-title">Delete Project</h3>
            <p class="danger-zone-section-text">
                Permanently delete this project and all associated tasks. This action cannot be undone.
            </p>
            <button onclick="deleteProject()" class="btn btn-danger">
                <i class="fas fa-trash"></i> Delete Project
            </button>
        </div>
    </div>
</div>

<script>
    // Transfer Ownership Function
    async function transferOwnership() {
        const newOwnerId = document.getElementById('newOwnerSelect').value;

        if (!newOwnerId) {
            alert('Please select a member to transfer ownership to');
            return;
        }

        const newOwnerName = document.getElementById('newOwnerSelect').options[document.getElementById('newOwnerSelect').selectedIndex].text;

        if (!confirm(`Transfer project ownership to ${newOwnerName}?\n\nYou will become a regular member after transfer. This action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/projects/<%= project._id %>/transfer-ownership`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ newOwnerId }),
                credentials: 'include'
            });

            const result = await response.json();

            if (result.success) {
                showAlert('success', 'Ownership transferred successfully! Redirecting...');
                setTimeout(() => {
                    window.location.href = `/projects/<%= project._id %>?success=Project ownership transferred`;
                }, 1500);
            } else {
                showAlert('error', result.message || 'Failed to transfer ownership');
            }
        } catch (error) {
            console.error('Transfer ownership error:', error);
            showAlert('error', 'Error: ' + error.message);
        }
    }

    // Delete Project Function
    async function deleteProject() {
        if (!confirm('Are you sure you want to delete this project?\n\nThis will permanently delete:\n• All project data\n• All tasks in this project\n• All member associations\n\nThis action cannot be undone.')) {
            return;
        }

        // Extra confirmation for deletion
        const projectName = prompt(`Type the project name "${'<%= project.name %>'}" to confirm deletion:`);

        if (projectName !== '<%= project.name %>') {
            alert('Project name does not match. Deletion cancelled.');
            return;
        }

        try {
            const response = await fetch(`/api/projects/<%= project._id %>`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const result = await response.json();

            if (result.success) {
                showAlert('success', 'Project deleted successfully! Redirecting...');
                setTimeout(() => { window.location.href = '/projects?success=Project deleted successfully'; }, 1500);
            } else {
                showAlert('error', result.message || 'Failed to delete project');
            }
        } catch (error) {
            console.error('Delete project error:', error);
            showAlert('error', 'Error: ' + error.message);
        }
    }

    // Remove Member Function
    async function removeMember(userId, userName) {
        if (!confirm(`Remove ${userName} from this project?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/projects/<%= project._id %>/members/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json'
                },
                credentials: 'include'
            });

            const result = await response.json();

            if (result.success) {
                showAlert('success', 'Member removed successfully');
                setTimeout(()=>{window.location.reload();}, 1000);
            } else {
                showAlert('error', result.message || 'Failed to remove member');
            }
        } catch (error) {
            console.error('Remove member error:', error);
            showAlert('error', 'Error: ' + error.message);
        }
    }
</script>