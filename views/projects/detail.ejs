<%- include('../layouts/main.ejs') -%>
    <div class="projects-container project-detail-container">
        <!-- Project Header -->
        <div class="project-detail-header">
            <a href="/projects" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to All Projects
            </a>
            <div class="project-detail-header-content">
                <div>
                    <h1 class="project-detail-title">
                        <%= project.name %>
                    </h1>
                    <% if (project.description) { %>
                        <p class="project-detail-description">
                            <%= project.description %>
                        </p>
                        <% } %>
                </div>
            </div>

            <div class="project-detail-meta">
                <div class="project-detail-meta-item">
                    <strong><i class="fas fa-person"></i>Created by:</strong>
                    <%= project.createdBy.username %>
                </div>
                <div class="project-detail-meta-item">
                    <strong><i class="fas fa-calendar-day"></i>Created on:</strong>
                    <%= new Date(project.createdAt).toLocaleDateString() %>
                </div>
                <% if (project.startDate) { %>
                    <div class="project-detail-meta-item">
                        <strong><i class="fas fa-hourglass-start"></i>Start:</strong>
                        <%= new Date(project.startDate).toLocaleDateString() %>
                    </div>
                    <% } %>
                        <% if (project.endDate) { %>
                            <div class="project-detail-meta-item">
                                <strong><i class="fas fa-hourglass-end"></i>End:</strong>
                                <%= new Date(project.endDate).toLocaleDateString() %>
                            </div>
                            <% } %>

                                <% if (project.endDate) { %>
                                    <% const today=new Date(); today.setHours(0, 0, 0, 0); const end=new
                                        Date(project.endDate); end.setHours(0, 0, 0, 0); const diffTime=end - today;
                                        const diffDays=Math.ceil(diffTime / (1000 * 60 * 60 * 24)); const
                                        totalTasks=tasks.length; const completedTasks=tasks.filter(t=> t.status ===
                                        'done').length;
                                        const isProjectCompleted = totalTasks > 0 && totalTasks === completedTasks;
                                        %>
                                        <div class="project-detail-meta-item">
                                            <% if (isProjectCompleted) { %>
                                                <strong><i class="fas fa-check-circle text-success"></i>Status:</strong>
                                                <span class="text-success">Completed</span>
                                                <% } else if (diffDays>= 0) { %>
                                                    <strong><i class="fas fa-clock"></i>Status:</strong>
                                                    <span class="text-success">
                                                        <%= diffDays %> day<%= diffDays !==1 ? 's' : '' %> remaining
                                                    </span>
                                                    <% } else { %>
                                                        <strong><i
                                                                class="fas fa-exclamation-circle text-danger"></i>Status:</strong>
                                                        <span class="text-danger">Due <%= Math.abs(diffDays) %> day<%=
                                                                    Math.abs(diffDays) !==1 ? 's' : '' %> ago</span>
                                                        <% } %>
                                        </div>
                                        <% } %>
                                            <div class="project-detail-meta-item">
                                                <strong><i class="fas fa-users"></i>Team Members:</strong>
                                                <% const teamMembersCount=project.members.filter(member=>
                                                    member._id.toString() !==
                                                    project.createdBy._id.toString()).length; %>
                                                    <%= teamMembersCount %>
                                            </div>
            </div>

            <% if (isOwner) { %>
                <a href="/projects/<%= project._id %>/edit" class="btn btn-primary">
                    <i class="fas fa-pen"></i> Edit Project
                </a>
                <% } %>
        </div>

        <!-- Two Column Layout -->
        <div class="project-detail-layout">
            <!-- Left Column: Tasks -->
            <div>
                <div class="project-detail-tasks">
                    <div class="project-detail-tasks-header">
                        <h2 class="project-detail-tasks-title">Tasks</h2>
                        <button onclick="showTaskForm()" class="btn btn-success">
                            <i class="fas fa-plus"></i> Add Task
                        </button>
                    </div>

                    <!-- Task Form -->
                    <div id="taskForm" class="task-form-modal">
                        <div class="task-form-modal-header">
                            <h3 class="task-form-modal-title">Create New Task</h3>
                            <button type="button" onclick="hideTaskForm()" class="task-form-modal-close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <form id="createTaskForm" class="project-form">
                            <input type="hidden" name="project" value="<%= project._id %>">

                            <div class="task-form-grid-2">
                                <div class="form-group">
                                    <label class="form-label">Task Title *</label>
                                    <input type="text" name="title" required placeholder="What needs to be done?"
                                        class="form-control">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Priority *</label>
                                    <select name="priority" required class="form-control form-select">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea name="description" rows="3"
                                    placeholder="Add details, instructions, or context..." class="form-control"
                                    style="resize: vertical;"></textarea>
                            </div>

                            <div class="task-form-grid-3">
                                <div class="form-group">
                                    <label class="form-label">Status *</label>
                                    <select name="status" required class="form-control form-select">
                                        <option value="todo" selected>To Do</option>
                                        <option value="in-progress">In Progress</option>
                                        <option value="done">Done</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Assign To</label>
                                    <select name="assignedTo" class="form-control form-select">
                                        <option value="">Unassigned</option>
                                        <option value="<%= user.id %>">Me (<%= user.username %>)</option>
                                        <% project.members.forEach(member=> { %>
                                            <% if (member._id.toString() !==user.id) { %>
                                                <option value="<%= member._id %>">
                                                    <%= member.username %>
                                                </option>
                                                <% } %>
                                                    <% }) %>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Due Date</label>
                                    <input type="date" name="dueDate"
                                        min="<%= new Date().toISOString().split('T')[0] %>" class="form-control">
                                </div>
                            </div>

                            <div class="project-form-actions">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus"></i> Create Task
                                </button>
                                <button type="button" onclick="hideTaskForm()" class="btn btn-secondary">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Tasks List -->
                    <% if (tasks.length> 0) { %>
                        <div class="tasks-list">
                            <% tasks.forEach(task=> { %>
                                <div class="task-card-small" onclick="window.location.href='/tasks/<%= task._id %>'">
                                    <div class="task-card-small-header">
                                        <h3 class="task-card-small-title">
                                            <%= task.title %>
                                                <% if (task.priority==='high' ) { %>
                                                    <span class="task-card-small-priority">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                    </span>
                                                    <% } %>
                                        </h3>
                                        <span class="task-card-small-status">
                                            <%= task.status %>
                                        </span>
                                    </div>

                                    <% if (task.description) { %>
                                        <p class="task-card-small-description">
                                            <%= task.description.substring(0, 80) %>
                                                <%= task.description.length> 80 ? '...' : '' %>
                                        </p>
                                        <% } %>

                                            <div class="task-card-small-meta">
                                                <div>
                                                    <% if (task.assignedTo) { %>
                                                        <i class="fas fa-user"></i>
                                                        <%= task.assignedTo.username %>
                                                            <% } else { %>
                                                                <i class="fas fa-user-slash"></i> Unassigned
                                                                <% } %>
                                                </div>
                                                <div>
                                                    <% if (task.dueDate) { %>
                                                        <i class="fas fa-calendar-day"></i>
                                                        <%= new Date(task.dueDate).toLocaleDateString() %>
                                                            <% } else { %>
                                                                <%= new Date(task.createdAt).toLocaleDateString() %>
                                                                    <% } %>
                                                </div>
                                            </div>

                                            <!-- Quick Actions -->
                                            <div class="task-card-small-actions" onclick="event.stopPropagation();">
                                                <button
                                                    onclick="quickUpdateTask('<%= task._id %>', '<%= task.project._id %>', '<%= task.status %>', '<%= task.priority %>')"
                                                    class="task-card-small-action-btn" title="Update task">
                                                    <i class="fas fa-edit"></i> Update
                                                </button>
                                                <button
                                                    onclick="deleteTask('<%= task._id %>', '<%= task.project._id %>', event)"
                                                    class="task-card-small-action-btn task-card-small-action-btn-delete"
                                                    title="Delete task">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                </div>
                                <% }) %>
                        </div>
                        <% } else { %>
                            <p style="text-align: center; color: var(--color-text-muted); padding: var(--space-xl);">
                                No tasks yet. Add your first task!
                            </p>
                            <% } %>
                </div>
            </div>

            <!-- Right Column: Members & Actions -->
            <div>
                <!-- Project Members Section -->
                <div class="project-detail-members">
                    <h3 class="project-detail-members-title">Project Team</h3>

                    <div class="member-list">
                        <!-- Owner -->
                        <div class="member-item member-item-owner">
                            <div class="member-avatar member-avatar-owner">
                                <%= project.createdBy.username.charAt(0).toUpperCase() %>
                            </div>
                            <div class="member-info">
                                <div class="member-name">
                                    <%= project.createdBy.username %>
                                </div>
                                <div class="member-role">Owner • <%= project.createdBy.email %>
                                </div>
                            </div>
                        </div>

                        <!-- Team Members -->
                        <% const teamMembers=project.members.filter(member=>
                            member._id.toString() !== project.createdBy._id.toString()) %>

                            <% if (teamMembers.length> 0) { %>
                                <% teamMembers.forEach(member=> { %>
                                    <div class="member-item">
                                        <div class="member-avatar member-avatar-member">
                                            <%= member.username.charAt(0).toUpperCase() %>
                                        </div>
                                        <div class="member-info">
                                            <div class="member-name">
                                                <%= member.username %>
                                            </div>
                                            <div class="member-role">Member • <%= member.email %>
                                            </div>
                                        </div>

                                        <% if (isOwner) { %>
                                            <div class="member-actions">
                                                <button
                                                    onclick="removeMember('<%= member._id %>', '<%= member.username %>')"
                                                    class="member-action-remove" title="Remove member">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            <% } %>
                                    </div>
                                    <% }) %>
                                        <% } else { %>
                                            <div
                                                style="text-align: center; padding: var(--space-md); color: var(--color-text-muted); font-style: italic;">
                                                No team members yet
                                            </div>
                                            <% } %>
                    </div>

                    <div class="member-summary">
                        <%= teamMembers.length %> team member(s)
                    </div>

                    <% if (isOwner) { %>
                        <button onclick="showMemberForm()" class="add-member-btn">
                            <i class="fas fa-user-plus"></i> Add Team Member
                        </button>
                        <% } %>
                </div>

                <% if (isOwner) { %>
                    <!-- Add Member Form -->
                    <div id="memberForm" class="member-form-modal">
                        <h4 class="member-form-modal-title">Add Team Member</h4>
                        <form id="addMemberForm">
                            <div class="form-group">
                                <label class="form-label">User Email</label>
                                <input type="email" id="searchEmail" placeholder="Enter user's email address"
                                    class="member-search-input">
                                <div id="userSuggestions" class="user-suggestions"></div>
                            </div>

                            <div id="selectedUser" class="selected-user">
                                <div class="selected-user-header">
                                    <div>
                                        <strong id="selectedUserName"></strong>
                                        <div style="font-size: 0.875rem; color: var(--color-text-secondary);"
                                            id="selectedUserEmail"></div>
                                    </div>
                                    <button type="button" onclick="clearSelectedUser()" class="selected-user-remove">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <input type="hidden" name="userId" id="selectedUserId">
                            </div>

                            <div class="project-form-actions">
                                <button type="submit" class="btn btn-success">
                                    Add Member
                                </button>
                                <button type="button" onclick="hideMemberForm()" class="btn btn-secondary">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                    <% } %>

                        <!-- Quick Actions -->
                        <div class="quick-actions-panel">
                            <h3 class="quick-actions-title">Quick Actions</h3>

                            <div class="quick-actions-list">
                                <a href="/projects/<%= project._id %>/tasks" class="quick-action-link">
                                    <i class="fas fa-tasks"></i> View All Tasks
                                </a>

                                <% if (isOwner) { %>
                                    <a href="/projects/<%= project._id %>/settings" class="quick-action-link">
                                        <i class="fas fa-cog"></i> Project Settings
                                    </a>

                                    <button
                                        onclick="if(confirm('Are you sure you want to delete this project?')) { deleteProject(); }"
                                        class="quick-action-btn">
                                        <i class="fas fa-trash"></i> Delete Project
                                    </button>
                                    <% } %>
                            </div>
                        </div>
            </div>
        </div>
    </div>

    <script>
        // Task Form Functions
        function showTaskForm() {
            document.getElementById('taskForm').classList.add('show');
            window.location.href = "#taskForm";
        }

        function hideTaskForm() {
            document.getElementById('taskForm').classList.remove('show');
        }

        // Task creation
        document.getElementById('createTaskForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            submitBtn.disabled = true;

            try {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                console.log('Raw form data:', data); // Debug log

                // Process data for API
                const taskData = {
                    title: data.title,
                    description: data.description || undefined, // Send undefined if empty
                    status: data.status || 'todo',
                    priority: data.priority || 'medium',
                    assignedTo: data.assignedTo || null, // Send null if empty
                    dueDate: data.dueDate || undefined
                };

                // Remove undefined fields
                Object.keys(taskData).forEach(key => {
                    if (taskData[key] === undefined) {
                        delete taskData[key];
                    }
                });

                console.log('Processed task data:', taskData); // Debug log

                const response = await fetch(`/api/projects/${data.project}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(taskData),
                    credentials: 'include'
                });

                console.log('Response status:', response.status); // Debug log

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text); // Debug log
                    throw new Error(`Server error: ${text.substring(0, 100)}`);
                }

                const result = await response.json();
                console.log('API Response:', result); // Debug log

                if (result.success) {
                    showAlert('success', 'Task created successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    let errorMessage = result.message || 'Failed to create task';
                    if (result.errors) {
                        errorMessage += '\n' + result.errors.map(err => {
                            const key = Object.keys(err)[0];
                            return `${key}: ${err[key]}`;
                        }).join('\n');
                    }
                    showAlert('error', errorMessage);
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Create task error:', error);
                showAlert('error', 'Network error: ' + error.message);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Member Form Functions
        function showMemberForm() {
            document.getElementById('memberForm').classList.add('show');
            window.location.href = "#memberForm";
            document.getElementById('searchEmail').focus();
        }

        function hideMemberForm() {
            document.getElementById('memberForm').classList.remove('show');
            clearSelectedUser();
        }

        function clearSelectedUser() {
            document.getElementById('selectedUser').classList.remove('show');
            document.getElementById('searchEmail').value = '';
            document.getElementById('userSuggestions').innerHTML = '';
            document.getElementById('selectedUserId').value = '';
        }
        // ========== USER SEARCH ==========
        let searchTimeout;
        document.getElementById('searchEmail').addEventListener('input', function (e) {
            const email = e.target.value.trim();

            clearTimeout(searchTimeout);

            if (email.length < 3) {
                document.getElementById('userSuggestions').innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    console.log('Searching users with email:', email);

                    // ✅ CRITICAL: Use credentials: 'include' for cookies
                    const response = await fetch(`/api/users/search?email=${encodeURIComponent(email)}`, {
                        credentials: 'include' // ← THIS SENDS THE COOKIE
                    });

                    console.log('Search response:', response.status);

                    const result = await response.json();
                    console.log('Search result:', result);

                    if (result.success && result.data.length > 0) {
                        const suggestions = result.data.map(user => `
                    <div style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; cursor: pointer;"
                         onclick="selectUser('${user._id}', '${user.username}', '${user.email}')">
                        <strong>${user.username}</strong>
                        <div style="font-size: 0.875rem; color: #6b7280;">${user.email}</div>
                    </div>
                `).join('');

                        document.getElementById('userSuggestions').innerHTML = suggestions;
                    } else {
                        document.getElementById('userSuggestions').innerHTML = `
                    <div style="padding: 0.5rem; color: #9ca3af;">
                        No users found with that email
                    </div>
                `;
                    }
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        });

        function selectUser(userId, userName, userEmail) {
            document.getElementById('selectedUser').style.display = 'block';
            document.getElementById('selectedUserName').textContent = userName;
            document.getElementById('selectedUserEmail').textContent = userEmail;
            document.getElementById('selectedUserId').value = userId;
            document.getElementById('userSuggestions').innerHTML = '';
            document.getElementById('searchEmail').value = '';
        }

        // ========== ADD MEMBER ==========
        document.getElementById('addMemberForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const userId = document.getElementById('selectedUserId').value;

            if (!userId) {
                alert('Please select a user first');
                return;
            }

            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            submitBtn.disabled = true;

            try {
                console.log('Adding member:', userId, 'to project:', '<%= project._id %>');

                const response = await fetch('/api/projects/<%= project._id %>/members', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId: userId }),
                    credentials: 'include'
                });

                console.log('Add member response:', response.status);

                const result = await response.json();
                console.log('Add member result:', result);

                if (result.success) {
                    showAlert('success', 'Member added successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert(result.message || 'Failed to add member');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Add member error:', error);
                showAlert('error', 'Network error:' + error.message);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // ========== REMOVE MEMBER ==========
        async function removeMember(userId, userName) {
            if (!confirm(`Remove ${userName} from this project?`)) {
                return;
            }

            try {
                const projectId = '<%= project._id %>';

                const response = await fetch(`/api/projects/${projectId}/members/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'Member removed successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // Show error message with task count info
                    let errorMessage = result.message || 'Failed to remove member';
                    if (result.errors) {
                        errorMessage += '\n' + result.errors.map(err => {
                            const key = Object.keys(err)[0];
                            return `${key}: ${err[key]}`;
                        }).join('\n');
                    }
                    showAlert('error', errorMessage);
                }

            } catch (error) {
                console.error('Remove member error:', error);
                showAlert('error', error.message);
            }
        }

        // ========== UPDATE TASK ==========
        function quickUpdateTask(taskId, projectId, currentStatus = 'todo', currentPriority = 'medium') {
            openQuickUpdateModal(taskId, projectId, currentStatus, currentPriority);
        }

        // ========== DELETE TASK ==========
        async function deleteTask(taskId, projectId, event) {
            // if (event) event.stopPropagation();

            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${projectId}/tasks/${taskId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'Task deleted successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('error', result.message);
                }
            } catch (error) {
                console.error('Delete task error:', error);
                alert('error', 'Network error: ' + error.message);
            }
        }

        // Delete Project Function
        async function deleteProject() {
            if (!confirm('Are you sure? This will delete the project and all its tasks.')) {
                return;
            }

            try {
                console.log('Deleting project:', '<%= project._id %>');

                const response = await fetch('/api/projects/<%= project._id %>', {
                    method: 'DELETE',
                    credentials: 'include'
                });

                console.log('Delete response:', response.status);

                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }

                const result = await response.json();
                console.log('Delete result:', result);

                if (result.success) {
                    window.location.href = '/projects?success=Project deleted successfully';
                } else {
                    showAlert('error', result.message || 'Failed to delete project');
                }
            } catch (error) {
                console.error('Delete project error:', error);
                showAlert('error', 'Network error: ' + error.message);
            }
        }
    </script>