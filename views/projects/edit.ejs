<%- include('../layouts/main.ejs') -%>

<div class="projects-container project-form-container">
    <div class="project-header">
        <a href="/projects/<%= project._id %>" class="project-back-link">
            <i class="fas fa-arrow-left"></i> Back to Project
        </a>
        <h1 class="project-title">Edit Project: <%= project.name %></h1>
    </div>

    <div class="project-form-card">
        <form id="editProjectForm" class="project-form">
            <div class="project-form-group">
                <label class="project-form-label">
                    Project Name *
                </label>
                <input 
                    type="text" 
                    name="name" 
                    required 
                    value="<%= project.name %>"
                    class="project-form-input"
                >
            </div>

            <div class="project-form-group">
                <label class="project-form-label">
                    Description
                </label>
                <textarea 
                    name="description" 
                    rows="4"
                    class="project-form-textarea"
                ><%= project.description || '' %></textarea>
            </div>

            <div class="project-form-actions">
                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-save"></i> Update Project
                </button>
                <a href="/projects/<%= project._id %>" class="btn btn-secondary">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('editProjectForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    submitBtn.disabled = true;

    try {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        console.log('Updating project with:', data);

        // ✅ CRITICAL: Use credentials: 'include' for cookies
        const response = await fetch('/api/projects/<%= project._id %>', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data),
            credentials: 'include' // ← THIS SENDS THE COOKIE
        });

        console.log('Response status:', response.status);

        const result = await response.json();
        console.log('API Response:', result);

        if (result.success) {
            // Redirect to the updated project
            setTimeout(() => {
                window.location.href = '/projects/<%= project._id %>?success=Project updated successfully';
            }, 1500);
        } else {
            // Show error message
            showAlert('error', result.message || 'Failed to update project');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('Update project error:', error);
        showAlert('error', 'Network error: ' + error.message);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});
</script>