<%- include('../layouts/main.ejs') -%>

<div class="projects-container project-tasks-container">
    <!-- Page Header -->
    <div class="project-tasks-header">
        <div class="project-tasks-header-content">
            <div class="project-tasks-header-main">
                <a href="/projects/<%= project._id %>" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Project
                </a>
                <h1 class="project-tasks-title">Tasks for: <%= project.name %></h1>
                <% if (project.description) { %>
                    <p class="project-tasks-description">
                        <%= project.description %>
                    </p>
                <% } %>
            </div>

            <div class="project-tasks-header-actions">
                <a href="/projects/<%= project._id %>" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Task
                </a>
            </div>
        </div>

        <!-- Stats -->
        <div class="project-tasks-stats">
            <div class="project-stat">
                <div class="project-stat-value project-stat-total">
                    <%= totalTasks %>
                </div>
                <div class="project-stat-label">Total Tasks</div>
            </div>

            <div class="project-stat">
                <div class="project-stat-value project-stat-todo">
                    <%= todoTasks %>
                </div>
                <div class="project-stat-label">To Do</div>
            </div>

            <div class="project-stat">
                <div class="project-stat-value project-stat-progress">
                    <%= inProgressTasks %>
                </div>
                <div class="project-stat-label">In Progress</div>
            </div>

            <div class="project-stat">
                <div class="project-stat-value project-stat-done">
                    <%= doneTasks %>
                </div>
                <div class="project-stat-label">Completed</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="project-tasks-filters">
        <h3 class="project-tasks-filters-title">Filter Tasks</h3>
        <form id="filterForm" class="project-tasks-filters-form">
            <div class="form-group">
                <label class="form-label">Status</label>
                <select name="status" class="form-control form-select">
                    <option value="">All Status</option>
                    <option value="todo">To Do</option>
                    <option value="in-progress">In Progress</option>
                    <option value="done">Done</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Priority</label>
                <select name="priority" class="form-control form-select">
                    <option value="">All Priorities</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Assigned To</label>
                <select name="assignedTo" class="form-control form-select">
                    <option value="">Everyone</option>
                    <option value="me">Assigned to Me</option>
                    <option value="unassigned">Unassigned</option>
                    <% allMembers.forEach(member => { %>
                        <option value="<%= member._id %>">
                            <%= member.username %>
                            <% if (member.isOwner) { %> (Owner)<% } %>
                        </option>
                    <% }) %>
                </select>
            </div>

            <div class="project-tasks-filters-actions">
                <button type="submit" class="btn btn-primary">
                    Apply Filters
                </button>
                <button type="button" onclick="clearFilters()" class="btn btn-secondary">
                    Clear
                </button>
            </div>
        </form>
    </div>

    <!-- Tasks Table -->
    <div class="project-tasks-table-container">
        <% if (tasks.length > 0) { %>
            <div style="overflow-x: auto;">
                <table class="project-tasks-table">
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Assigned To</th>
                            <th>Due Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% tasks.forEach(task => { %>
                            <tr>
                                <td>
                                    <div>
                                        <strong class="project-task-cell-title">
                                            <a href="/tasks/<%= task._id %>">
                                                <%= task.title %>
                                            </a>
                                        </strong>
                                        <% if (task.description) { %>
                                            <small class="project-task-cell-description">
                                                <%= task.description.substring(0, 60) %>
                                                <%= task.description.length > 60 ? '...' : '' %>
                                            </small>
                                        <% } %>
                                    </div>
                                </td>
                                <td>
                                    <span class="task-badge status-<%= task.status %>">
                                        <%= task.status %>
                                    </span>
                                </td>
                                <td>
                                    <% if (task.priority === 'high') { %>
                                        <span class="task-detail-meta due-date-overdue">
                                            <i class="fas fa-arrow-up"></i> High
                                        </span>
                                    <% } else if (task.priority === 'medium') { %>
                                        <span class="task-detail-meta due-date-today">
                                            Medium
                                        </span>
                                    <% } else { %>
                                        <span class="task-detail-meta due-date-upcoming">
                                            Low
                                        </span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (task.assignedTo) { %>
                                        <div class="user-display-small">
                                            <div class="user-avatar-small">
                                                <%= task.assignedTo.username.charAt(0).toUpperCase() %>
                                            </div>
                                            <span class="user-name-small">
                                                <%= task.assignedTo.username %>
                                            </span>
                                        </div>
                                    <% } else { %>
                                        <span class="task-detail-meta due-date-none">Unassigned</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (task.dueDate) { %>
                                        <%= new Date(task.dueDate).toLocaleDateString() %>
                                    <% } else { %>
                                        <span class="task-detail-meta due-date-none">No due date</span>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="project-task-cell-actions">
                                        <a href="/tasks/<%= task._id %>" class="btn-icon btn-icon-view" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button onclick="quickUpdateTask('<%= task._id %>', '<%= task.project._id %>', '<%= task.status %>', '<%= task.priority %>')" class="btn-icon btn-icon-edit" title="Update">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <% if (isOwner || task.createdBy._id.toString() === user.id) { %>
                                            <button onclick="deleteTask('<%= task._id %>', '<%= project._id %>')" class="btn-icon btn-icon-delete" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        <% } %>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <div class="project-tasks-empty">
                <div class="project-tasks-empty-icon">
                    <i class="fas fa-tasks"></i>
                </div>
                <h3 class="project-tasks-empty-title">No tasks found</h3>
                <p class="project-tasks-empty-text">No tasks match your filters or project has no tasks yet</p>
                <a href="/projects/<%= project._id %>" class="btn btn-primary" style="margin-top: var(--space-md);">
                    <i class="fas fa-plus"></i> Add First Task
                </a>
            </div>
        <% } %>
    </div>
</div>

<script>
// Filter handling
document.getElementById('filterForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    const params = new URLSearchParams();

    for (const [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }

    window.location.href = window.location.pathname + '?' + params.toString();
});

function clearFilters() {
    window.location.href = window.location.pathname;
}

// Initialize filters from URL
document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);

    ['status', 'priority', 'assignedTo'].forEach(param => {
        const value = urlParams.get(param);
        if (value) {
            const select = document.querySelector(`[name="${param}"]`);
            if (select) select.value = value;
        }
    });
});

// Task functions
function quickUpdateTask(taskId, projectId, currentStatus = 'todo', currentPriority = 'medium') {
    console.log('=== UPDATE TASK DEBUG ===');
    console.log('Task ID:', taskId);
    console.log('Project ID:', projectId);
    console.log('Current Status:', currentStatus);
    console.log('Current Priority:', currentPriority);
    openQuickUpdateModal(taskId, projectId, currentStatus, currentPriority);
}

async function deleteTask(taskId, projectId) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }

    try {
        const response = await fetch(`/api/projects/${projectId}/tasks/${taskId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        const result = await response.json();

        if (result.success) {
            showAlert('success', 'Task deleted successfully');
            setTimeout(() => { window.location.reload(); }, 1000);
        } else {
            showAlert('error', result.message || 'Failed to delete task');
        }
    } catch (error) {
        console.error('Delete task error:', error);
        showAlert('error', 'Network error: ' + error.message);
    }
}
</script>