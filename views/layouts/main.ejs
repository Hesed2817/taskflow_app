<!-- views/layouts/main.ejs -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Reddit Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Reddit+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- CSS Files -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/alerts.css">
    <link rel="stylesheet" href="/css/modals.css">

    <!-- Page-specific CSS -->
    <% if (cssFile) { %>
        <link rel="stylesheet" href="/css/pages/<%= cssFile %>.css">
        <% } %>
</head>

<body>
    <% if (locals.user) { %>
        <header class="header">
            <div class="header-container">
                <h1 class="header-logo" onclick="window.location.href='/dashboard'">TaskFlow</h1>

                <button class="menu-toggle" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="menu-backdrop" id="menuBackdrop" onclick="toggleMobileMenu()"></div>

                <nav class="nav" id="mainNav">
                    <a href="/dashboard" class="nav-link">
                        <i class="fas fa-house"></i> Dashboard
                    </a>
                    <a href="/projects" class="nav-link">
                        <i class="fas fa-folder-open"></i> Projects
                    </a>
                    <a href="/tasks" class="nav-link">
                        <i class="fas fa-clipboard-check"></i> Tasks
                    </a>

                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i>
                        <i class="fas fa-sun"></i>
                    </button>

                    <div class="user-menu-wrapper">
                        <button class="user-menu-btn" onclick="toggleUserMenu(event)">
                            <div class="user-avatar">
                                <%= user.username.charAt(0).toUpperCase() %>
                            </div>
                            <span class="user-name">
                                <%= user.username %>
                            </span>
                            <i class="fas fa-chevron-down"></i>
                        </button>

                        <div class="user-menu" id="userMenu">
                            <a href="/profile" class="user-menu-link">
                                <i class="fas fa-user"></i> My Profile
                            </a>
                            <a href="/logout" class="user-menu-link logout">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
        </header>
        <% } %>

            <main>

                <!-- Alert Container -->
                <div id="alertContainer" class="alert-container"></div>

                <!-- Alert Template (hidden by default) -->
                <template id="alertTemplate" class="alert-template">
                    <div class="alert">
                        <div class="alert-icon"></div>
                        <div class="alert-content">
                            <div class="alert-title"></div>
                            <div class="alert-message"></div>
                        </div>
                        <button class="alert-close" onclick="this.closest('.alert').remove()">
                            &times;
                        </button>
                    </div>
                </template>

                <style>
                    @keyframes slideIn {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }

                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }

                    @keyframes fadeOut {
                        from {
                            opacity: 1;
                        }

                        to {
                            opacity: 0;
                        }
                    }

                    .alert.fade-out {
                        animation: fadeOut 0.3s ease-out forwards;
                    }
                </style>

            </main>

            <!-- Quick Update Modal -->
            <div id="quickUpdateModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Update Task</h3>
                        <button class="modal-close" onclick="closeQuickUpdateModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <form id="quickUpdateForm" class="modal-form">
                        <input type="hidden" id="updateTaskId">
                        <input type="hidden" id="updateProjectId">

                        <div class="form-group">
                            <label for="updateStatus" class="form-label">Status</label>
                            <select id="updateStatus" class="form-control form-select">
                                <option value="todo">To Do</option>
                                <option value="in-progress">In Progress</option>
                                <option value="done">Done</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="updatePriority" class="form-label">Priority</label>
                            <select id="updatePriority" class="form-control form-select">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">
                                Update
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="closeQuickUpdateModal()">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>


            <script>
                // Theme Management
                function getTheme() {
                    return localStorage.getItem('theme') || 'light';
                }

                function setTheme(theme) {
                    localStorage.setItem('theme', theme);
                    document.documentElement.setAttribute('data-theme', theme);
                }

                function toggleTheme() {
                    const currentTheme = getTheme();
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    setTheme(newTheme);
                }

                // Initialize theme on page load
                document.addEventListener('DOMContentLoaded', function () {
                    const savedTheme = getTheme();
                    setTheme(savedTheme);

                    // Mobile menu toggle
                    window.toggleMobileMenu = function () {
                        const nav = document.getElementById('mainNav');
                        const backdrop = document.getElementById('menuBackdrop');
                        nav.classList.toggle('show');
                        backdrop.classList.toggle('show');
                    };

                    // Close mobile menu when clicking outside
                    document.addEventListener('click', function (event) {
                        const nav = document.getElementById('mainNav');
                        const menuToggle = document.querySelector('.menu-toggle');
                        const backdrop = document.getElementById('menuBackdrop');

                        if (nav && menuToggle &&
                            !nav.contains(event.target) &&
                            !menuToggle.contains(event.target) &&
                            nav.classList.contains('show')) {
                            nav.classList.remove('show');
                            backdrop.classList.remove('show');
                        }
                    });
                });

                // Updated User Menu Function with mobile support
                function toggleUserMenu(event) {
                    if (event) {
                        event.stopPropagation();
                    }

                    const menu = document.getElementById('userMenu');
                    menu.classList.toggle('show');
                }

                // Close menu when clicking outside (updated for new structure)
                document.addEventListener('click', function (event) {
                    const menu = document.getElementById('userMenu');
                    const button = document.querySelector('.user-menu-btn');

                    if (menu && button && !menu.contains(event.target) && !button.contains(event.target)) {
                        menu.classList.remove('show');
                    }
                });

                // Alert System              
                function showAlert(type, message, title = '', duration = 5000) {
                    // Validate inputs
                    if (!message || typeof message !== 'string' || message.trim() === '') {
                        console.warn('showAlert called with empty message');
                        return null;
                    }

                    // Get container and template
                    const container = document.getElementById('alertContainer');
                    const template = document.getElementById('alertTemplate');

                    if (!container || !template) {
                        console.error('Alert container or template not found');
                        return null;
                    }

                    // Clone the template content (not the template itself)
                    const alertContent = template.content.cloneNode(true);
                    const alertEl = alertContent.querySelector('.alert');

                    // Configure based on type
                    let icon, color, defaultTitle;
                    switch (type) {
                        case 'success':
                            icon = '✓';
                            color = 'var(--color-success)';
                            defaultTitle = 'Success';
                            break;
                        case 'error':
                            icon = '✗';
                            color = 'var(--color-danger)';
                            defaultTitle = 'Error';
                            break;
                        case 'warning':
                            icon = '⚠';
                            color = 'var(--color-warning)';
                            defaultTitle = 'Warning';
                            break;
                        case 'info':
                            icon = 'ℹ';
                            color = 'var(--color-info)';
                            defaultTitle = 'Info';
                            break;
                        default:
                            icon = 'ℹ';
                            color = 'var(--color-primary)';
                            defaultTitle = 'Notice';
                    }

                    // Use provided title or default
                    const finalTitle = title || defaultTitle;

                    // Configure the alert
                    alertEl.classList.add(`alert-${type}`);
                    alertEl.style.borderLeftColor = color;

                    const iconEl = alertEl.querySelector('.alert-icon');
                    const titleEl = alertEl.querySelector('.alert-title');
                    const messageEl = alertEl.querySelector('.alert-message');

                    if (iconEl) {
                        iconEl.textContent = icon;
                        iconEl.style.color = color;
                    }

                    if (titleEl) titleEl.textContent = finalTitle;
                    if (messageEl) messageEl.textContent = message;

                    // Add close button handler
                    const closeBtn = alertEl.querySelector('.alert-close');
                    if (closeBtn) {
                        closeBtn.onclick = function () {
                            dismissAlert(alertEl);
                        };
                    }

                    // Add to container
                    container.appendChild(alertEl);

                    // Auto-dismiss after duration
                    if (duration > 0) {
                        setTimeout(() => {
                            dismissAlert(alertEl);
                        }, duration);
                    }

                    return alertEl;
                }

                function dismissAlert(alertEl) {
                    if (!alertEl || !alertEl.parentNode) return;

                    alertEl.classList.add('fade-out');

                    setTimeout(() => {
                        if (alertEl.parentNode) {
                            alertEl.parentNode.removeChild(alertEl);
                        }

                        // Hide container if empty
                        const container = document.getElementById('alertContainer');
                        if (container && container.children.length === 0) {
                            container.style.display = 'none';
                        }
                    }, 300);
                }

                // Enhanced URL parameter handling
                document.addEventListener('DOMContentLoaded', function () {
                    const urlParams = new URLSearchParams(window.location.search);
                    const container = document.getElementById('alertContainer');

                    // Function to safely show alert from URL
                    function showAlertFromUrl(param, type) {
                        const value = urlParams.get(param);
                        if (value && value.trim() !== '' && value !== 'undefined' && value !== 'null') {
                            showAlert(type, value.trim());

                            // Clean URL without reloading
                            const url = new URL(window.location);
                            url.searchParams.delete(param);

                            // Clean up any other empty params
                            for (const [key, val] of url.searchParams.entries()) {
                                if (!val || val.trim() === '' || val === 'undefined' || val === 'null') {
                                    url.searchParams.delete(key);
                                }
                            }

                            let newSearch = url.search;
                            if (newSearch === '?') newSearch = '';

                            window.history.replaceState({}, document.title, url.pathname + newSearch + url.hash);
                        }
                    }

                    // Check for alert parameters
                    showAlertFromUrl('success', 'success');
                    showAlertFromUrl('error', 'error');
                    showAlertFromUrl('warning', 'warning');
                    showAlertFromUrl('info', 'info');
                });

                // Global functions
                window.showSuccess = (message, title) => showAlert('success', message, title);
                window.showError = (message, title) => showAlert('error', message, title);
                window.showWarning = (message, title) => showAlert('warning', message, title);
                window.showInfo = (message, title) => showAlert('info', message, title);

                // Updated Quick Update Modal Functions
                function openQuickUpdateModal(taskId, projectId, currentStatus, currentPriority) {
                    currentTaskData = { taskId, projectId };

                    // Set current values
                    const statusSelect = document.getElementById('updateStatus');
                    const prioritySelect = document.getElementById('updatePriority');

                    if (currentStatus && statusSelect) {
                        statusSelect.value = currentStatus;
                    }
                    if (currentPriority && prioritySelect) {
                        prioritySelect.value = currentPriority;
                    }

                    const taskIdInput = document.getElementById('updateTaskId');
                    const projectIdInput = document.getElementById('updateProjectId');

                    if (taskIdInput) taskIdInput.value = taskId;
                    if (projectIdInput) projectIdInput.value = projectId;

                    const modal = document.getElementById('quickUpdateModal');
                    if (modal) {
                        modal.classList.add('show');
                    }
                }

                function closeQuickUpdateModal() {
                    const modal = document.getElementById('quickUpdateModal');
                    if (modal) {
                        modal.classList.remove('show');
                    }
                    currentTaskData = null;
                }

                // Close modal when clicking outside
                document.addEventListener('click', function (event) {
                    const modal = document.getElementById('quickUpdateModal');
                    if (modal && event.target === modal) {
                        closeQuickUpdateModal();
                    }
                });

                // Handle quick update form submission
                document.getElementById('quickUpdateForm').addEventListener('submit', async function (e) {
                    e.preventDefault();

                    console.log('=== SUBMITTING UPDATE ===');

                    const form = e.target;
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;

                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                    submitBtn.disabled = true;

                    try {
                        const data = {
                            status: document.getElementById('updateStatus').value,
                            priority: document.getElementById('updatePriority').value
                        };

                        console.log('Data to send:', data);
                        console.log('Status value type:', typeof data.status);
                        console.log('Priority value type:', typeof data.priority);

                        const response = await fetch(`/api/projects/${currentTaskData.projectId}/tasks/${currentTaskData.taskId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data),
                            credentials: 'include'
                        });

                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await response.text();
                            throw new Error(`Expected JSON but got: ${text.substring(0, 100)}`);
                        }

                        const result = await response.json();

                        if (result.success) {
                            closeQuickUpdateModal();
                            showAlert('success', 'Task updated successfully');
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showAlert('error', result.message || 'Failed to update task');
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        }
                    } catch (error) {
                        console.error('Quick update error:', error);
                        showAlert('error', 'Error: ' + error.message);
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                });
            </script>
</body>

</html>