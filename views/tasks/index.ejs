<%- include('../layouts/main.ejs') -%>

<div class="tasks-container">
    <!-- Header with Actions -->
    <div class="tasks-header">
        <div class="tasks-header-content">
            <h1 class="task-title">All Tasks</h1>
            <p class="task-subtitle">View and manage tasks across all your projects</p>
        </div>
        <div class="tasks-header-actions">
            <button onclick="showFilters()" class="btn btn-secondary">
                <i class="fas fa-filter"></i> Filter
            </button>
            <a href="/projects" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Task
            </a>
        </div>
    </div>

    <!-- Filters Panel -->
    <div id="filtersPanel" class="filters-panel">
        <h3 class="filters-title">Filter Tasks</h3>
        <form id="filterForm" class="filters-form">
            <div class="form-group">
                <label class="form-label">Status</label>
                <select name="status" class="form-control form-select">
                    <option value="">All Status</option>
                    <option value="todo">To Do</option>
                    <option value="in-progress">In Progress</option>
                    <option value="done">Done</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Priority</label>
                <select name="priority" class="form-control form-select">
                    <option value="">All Priorities</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Project</label>
                <select name="project" class="form-control form-select">
                    <option value="">All Projects</option>
                    <% projects.forEach(project => { %>
                        <option value="<%= project._id %>"><%= project.name %></option>
                    <% }) %>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Assigned To</label>
                <select name="assignedTo" class="form-control form-select">
                    <option value="">Everyone</option>
                    <option value="me">Assigned to Me</option>
                    <option value="unassigned">Unassigned</option>
                </select>
            </div>
            
            <div class="filters-actions">
                <button type="submit" class="btn btn-primary">
                    Apply Filters
                </button>
                <button type="button" onclick="clearFilters()" class="btn btn-secondary">
                    Clear All
                </button>
                <button type="button" onclick="hideFilters()" class="btn btn-gray">
                    Close
                </button>
            </div>
        </form>
    </div>

    <!-- Tasks Summary -->
    <div class="tasks-summary">
        <div class="summary-card summary-total">
            <h3 class="summary-card-title">Total Tasks</h3>
            <p class="summary-card-value"><%= tasks.length %></p>
        </div>
        
        <div class="summary-card summary-todo">
            <h3 class="summary-card-title">To Do</h3>
            <p class="summary-card-value"><%= tasks.filter(t => t.status === 'todo').length %></p>
        </div>
        
        <div class="summary-card summary-progress">
            <h3 class="summary-card-title">In Progress</h3>
            <p class="summary-card-value"><%= tasks.filter(t => t.status === 'in-progress').length %></p>
        </div>
        
        <div class="summary-card summary-completed">
            <h3 class="summary-card-title">Completed</h3>
            <p class="summary-card-value"><%= tasks.filter(t => t.status === 'done').length %></p>
        </div>
    </div>

    <!-- Tasks Table -->
    <div class="tasks-table-container">
        <div style="overflow-x: auto;">
            <table class="tasks-table">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Project</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Assigned To</th>
                        <th>Due Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (tasks.length > 0) { %>
                        <% tasks.forEach(task => { %>
                            <tr>
                                <td>
                                    <span class="task-cell-title"><%= task.title %></span>
                                    <% if (task.description) { %>
                                        <span class="task-cell-description">
                                            <%= task.description.substring(0, 50) %>
                                            <%= task.description.length > 50 ? '...' : '' %>
                                        </span>
                                    <% } %>
                                </td>
                                <td>
                                    <a href="/projects/<%= task.project._id %>" class="task-cell-project">
                                        <%= task.project.name %>
                                    </a>
                                </td>
                                <td>
                                    <span class="task-badge status-<%= task.status %>">
                                        <%= task.status %>
                                    </span>
                                </td>
                                <td>
                                    <% if (task.priority === 'high') { %>
                                        <span class="task-detail-meta due-date-overdue">
                                            <i class="fas fa-arrow-up"></i> High
                                        </span>
                                    <% } else if (task.priority === 'medium') { %>
                                        <span class="task-detail-meta due-date-today">
                                            Medium
                                        </span>
                                    <% } else { %>
                                        <span class="task-detail-meta due-date-upcoming">
                                            Low
                                        </span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (task.assignedTo) { %>
                                        <div class="user-display" style="align-items: center; gap: var(--space-sm);">
                                            <div class="user-avatar user-avatar-success" style="width: 24px; height: 24px; font-size: 0.75rem;">
                                                <%= task.assignedTo.username.charAt(0).toUpperCase() %>
                                            </div>
                                            <span class="user-name" style="font-size: 0.875rem;">
                                                <%= task.assignedTo.username %>
                                            </span>
                                        </div>
                                    <% } else { %>
                                        <span class="task-detail-meta due-date-none">Unassigned</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (task.dueDate) { %>
                                        <% const dueInDays = Math.ceil((new Date(task.dueDate) - new Date()) / (1000 * 60 * 60 * 24)); %>
                                        <% if (dueInDays < 0) { %>
                                            <span class="task-detail-meta due-date-overdue">
                                                <%= new Date(task.dueDate).toLocaleDateString() %>
                                            </span>
                                        <% } else if (dueInDays === 0) { %>
                                            <span class="task-detail-meta due-date-today">
                                                Today
                                            </span>
                                        <% } else if (dueInDays <= 3) { %>
                                            <span class="task-detail-meta due-date-today">
                                                <%= new Date(task.dueDate).toLocaleDateString() %>
                                            </span>
                                        <% } else { %>
                                            <span class="task-detail-meta due-date-upcoming">
                                                <%= new Date(task.dueDate).toLocaleDateString() %>
                                            </span>
                                        <% } %>
                                    <% } else { %>
                                        <span class="task-detail-meta due-date-none">No due date</span>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="task-cell-actions">
                                        <a href="/tasks/<%= task._id %>" class="btn-icon" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="/projects/<%= task.project._id %>" class="btn-icon" title="Go to Project">
                                            <i class="fas fa-project-diagram"></i>
                                        </a>
                                        <% if (task.createdBy._id.toString() === user.id || task.project.createdBy._id.toString() === user.id) { %>
                                            <button onclick="quickUpdateTask('<%= task._id %>', '<%= task.project._id %>', '<%= task.status %>', '<%= task.priority %>')" class="btn-icon" title="Update Status">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        <% } %>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="7" class="table-empty-state">
                                <div class="table-empty-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <h3 class="table-empty-title">No tasks found</h3>
                                <p class="table-empty-text">Create tasks in your projects to see them here</p>
                                <a href="/projects" class="btn btn-primary" style="margin-top: var(--space-md);">
                                    Go to Projects
                                </a>
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Filter Functions
function showFilters() {
    document.getElementById('filtersPanel').classList.add('show');
}

function hideFilters() {
    document.getElementById('filtersPanel').classList.remove('show');
}

function clearFilters() {
    document.getElementById('filterForm').reset();
    // Apply cleared filters by submitting
    document.getElementById('filterForm').submit();
}

// Handle Filter Form Submission
document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const params = new URLSearchParams();
    
    for (const [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    
    // Navigate to filtered URL
    window.location.href = '/tasks?' + params.toString();
});

// Quick Status Update
function quickUpdateTask(taskId, projectId, currentStatus = 'todo', currentPriority = 'medium') {
    openQuickUpdateModal(taskId, projectId, currentStatus, currentPriority);
}

// Initialize filters from URL params
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Set filter values from URL
    const status = urlParams.get('status');
    const priority = urlParams.get('priority');
    const project = urlParams.get('project');
    const assignedTo = urlParams.get('assignedTo');
    
    if (status) document.querySelector('[name="status"]').value = status;
    if (priority) document.querySelector('[name="priority"]').value = priority;
    if (project) document.querySelector('[name="project"]').value = project;
    if (assignedTo) document.querySelector('[name="assignedTo"]').value = assignedTo;
    
    // If any filters are active, show the filter panel
    if (status || priority || project || assignedTo) {
        showFilters();
    }
});

// Add button icon styles (if not already in components.css)
const style = document.createElement('style');
style.textContent = `
.btn-icon {
    background: none;
    border: none;
    color: var(--color-text-secondary);
    cursor: pointer;
    padding: var(--space-xs);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    font-size: 1rem;
    line-height: 1;
}

.btn-icon:hover {
    background-color: var(--color-bg-secondary);
    color: var(--color-primary);
}

.btn-gray {
    background-color: var(--color-text-muted);
    color: white;
}

.btn-gray:hover {
    background-color: var(--color-text-secondary);
}
`;
document.head.appendChild(style);
</script>