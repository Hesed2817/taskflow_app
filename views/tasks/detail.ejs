<%- include('../layouts/main.ejs') -%>

<div class="tasks-container">
    <div class="task-header">
        <a href="/tasks" class="task-back-link">
            <i class="fas fa-arrow-left"></i> Back to All Tasks
        </a>
        <h1 class="task-title"><%= task.title %></h1>
    </div>

    <!-- Main Task Card -->
    <div class="task-card">
        <!-- Task Header -->
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-lg);">
            <div>
                <div class="task-badges">
                    <span class="task-badge task-status-badge status-<%= task.status %>">
                        <%= task.status.toUpperCase() %>
                    </span>

                    <span class="task-badge task-priority-badge priority-<%= task.priority %>">
                        <%= task.priority.toUpperCase() %> PRIORITY
                    </span>
                </div>

                <div class="task-detail-meta" style="margin-bottom: var(--space-md);">
                    <i class="fas fa-project-diagram"></i>
                    <a href="/projects/<%= task.project._id %>" class="task-cell-project">
                        <%= task.project.name %>
                    </a>
                </div>
            </div>

            <% if (isOwner) { %>
                <a href="/tasks/<%= task._id %>/edit" class="btn btn-warning">
                    <i class="fas fa-edit"></i> Edit Task
                </a>
            <% } %>
        </div>

        <!-- Task Description -->
        <% if (task.description) { %>
            <div class="task-description">
                <h3 class="task-description-title">Description</h3>
                <p class="task-description-content"><%= task.description %></p>
            </div>
        <% } %>

        <!-- Task Details Grid -->
        <div class="task-details-grid">
            <!-- Assigned To -->
            <div class="task-detail">
                <h4 class="task-detail-label">ASSIGNED TO</h4>
                <% if (task.assignedTo) { %>
                    <div class="user-display">
                        <div class="user-avatar user-avatar-success">
                            <%= task.assignedTo.username.charAt(0).toUpperCase() %>
                        </div>
                        <div class="user-info">
                            <div class="user-name"><%= task.assignedTo.username %></div>
                            <div class="user-role"><%= task.assignedTo.email %></div>
                        </div>
                    </div>
                <% } else { %>
                    <div class="task-detail-meta">
                        <i class="fas fa-user-slash"></i> Not assigned
                    </div>
                <% } %>
            </div>

            <!-- Created By -->
            <div class="task-detail">
                <h4 class="task-detail-label">CREATED BY</h4>
                <div class="user-display">
                    <div class="user-avatar user-avatar-primary">
                        <%= task.createdBy.username.charAt(0).toUpperCase() %>
                    </div>
                    <div class="user-info">
                        <div class="user-name"><%= task.createdBy.username %></div>
                        <div class="user-role">Creator</div>
                    </div>
                </div>
            </div>

            <!-- Due Date -->
            <div class="task-detail">
                <h4 class="task-detail-label">DUE DATE</h4>
                <% if (task.dueDate) { %>
                    <div class="task-detail-value">
                        <%= new Date(task.dueDate).toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        }) %>
                    </div>
                    <% const dueInDays = Math.ceil((new Date(task.dueDate) - new Date()) / (1000 * 60 * 60 * 24)); %>
                    <% if (dueInDays < 0) { %>
                        <div class="task-detail-meta due-date-overdue">
                            <i class="fas fa-exclamation-circle"></i> Overdue by <%= Math.abs(dueInDays) %> days
                        </div>
                    <% } else if (dueInDays === 0) { %>
                        <div class="task-detail-meta due-date-today">
                            <i class="fas fa-clock"></i> Due today
                        </div>
                    <% } else if (dueInDays <= 3) { %>
                        <div class="task-detail-meta due-date-today">
                            <i class="fas fa-clock"></i> Due in <%= dueInDays %> days
                        </div>
                    <% } else { %>
                        <div class="task-detail-meta due-date-upcoming">
                            <i class="fas fa-calendar-check"></i> Due in <%= dueInDays %> days
                        </div>
                    <% } %>
                <% } else { %>
                    <div class="task-detail-meta due-date-none">
                        <i class="fas fa-calendar-times"></i> No due date set
                    </div>
                <% } %>
            </div>

            <!-- Created Date -->
            <div class="task-detail">
                <h4 class="task-detail-label">CREATED</h4>
                <div class="task-detail-value">
                    <%= new Date(task.createdAt).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    }) %>
                </div>
                <div class="task-detail-meta">
                    <i class="fas fa-clock"></i> <%= new Date(task.createdAt).toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }) %>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <% if (isOwner || task.assignedTo?._id?.toString() === user.id) { %>
            <div class="task-quick-actions">
                <h4 class="task-quick-actions-title">Quick Actions</h4>
                <div class="task-actions">
                    <button onclick="quickUpdateTask('<%= task._id %>', '<%= task.project._id %>', '<%= task.status %>', '<%= task.priority %>')" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Update Status
                    </button>

                    <% if (isOwner) { %>
                        <button onclick="deleteTask()" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Delete Task
                        </button>
                    <% } %>
                </div>
            </div>
        <% } %>
    </div>

    <!-- Comments Section -->
    <div class="task-comments">
        <h3 class="task-comments-title">Comments</h3>
        <div class="task-comments-empty">
            <i class="fas fa-comments task-comments-icon"></i>
            Comments feature coming soon!
        </div>
    </div>
</div>

<script>
function quickUpdateTask(taskId, projectId, currentStatus = 'todo', currentPriority = 'medium') {
    openQuickUpdateModal(taskId, projectId, currentStatus, currentPriority);
}

async function deleteTask() {
    if (!confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
        return;
    }

    try {
        const projectId = '<%= task.project._id %>';
        const taskId = '<%= task._id %>';

        const response = await fetch(`/api/projects/${projectId}/tasks/${taskId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error(`Server error: ${text.substring(0, 100)}`);
        }

        const result = await response.json();

        if (result.success) {
            window.location.href = `/projects/${projectId}/tasks?success=Task deleted successfully`;
        } else {
            showAlert('error', result.message || 'Failed to delete task');
        }
    } catch (error) {
        console.error('Delete task error:', error);
        showAlert('error', 'Error: ' + error.message);
    }
}
</script>